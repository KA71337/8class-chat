<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>8Ч Класс - Онлайн чат</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);height:100vh;display:flex;justify-content:center;align-items:center;}
  .auth-screen{background:white;padding:40px;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,0.3);text-align:center;display:flex;flex-direction:column;gap:16px;}
  .auth-screen h1{margin:0;font-size:24px;color:#111;}
  .auth-screen input{padding:12px;border-radius:10px;border:1px solid #ddd;font-size:14px;outline:none;}
  .auth-screen .btn{padding:10px 16px;border:none;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-weight:600;cursor:pointer;transition:0.2s;}
  .auth-screen .btn:hover{transform:translateY(-2px);}
  .app{display:none;width:92%;max-width:1100px;height:88vh;background:white;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,0.3);overflow:hidden;display:flex;flex-direction:row;}
  .users-panel{width:260px;background:#f7f8ff;border-right:1px solid #ddd;display:flex;flex-direction:column;padding:16px;}
  .category{font-weight:700;margin-top:10px;margin-bottom:6px;color:#333;}
  .category-item{padding:6px 8px;color:#555;font-size:14px;cursor:pointer;transition:0.15s;}
  .category-item:hover{background:rgba(102,126,234,0.08);border-radius:6px;}
  .chat-panel{flex:1;display:flex;flex-direction:column;}
  .chat-header{height:60px;display:flex;align-items:center;padding:0 16px;border-bottom:1px solid #ddd;font-weight:700;justify-content:space-between;}
  .messages{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:8px;}
  .msg{max-width:70%;padding:10px 14px;border-radius:12px;background:#eef2ff;align-self:flex-start;}
  .msg.me{align-self:flex-end;background:linear-gradient(90deg,#667eea,#764ba2);color:white;}
  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid #ddd;}
  .composer input{flex:1;padding:10px;border-radius:10px;border:1px solid #ccc;outline:none;}
  .composer button{padding:10px 16px;border:none;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;cursor:pointer;}
  .admin-btn{padding:8px 12px;border-radius:10px;background:linear-gradient(135deg,#e08b8b,#d94a4a);color:white;border:none;cursor:pointer;margin-left:auto;}
</style>
</head>
<body>
<div class="auth-screen" id="authScreen">
  <h1>Добро пожаловать на сайт 8ч класса</h1>
  <input type="text" id="nameInput" placeholder="Введите своё имя">
  <button class="btn" id="loginBtn">Войти</button>
</div>

<div class="app" id="app">
  <div class="users-panel">
    <div class="category">Группы</div>
    <div class="category-item" id="generalGroup">Общий чат</div>
    <div class="category">Пользователи</div>
    <div id="usersList"></div>
  </div>
  <div class="chat-panel">
    <div class="chat-header">
      <span id="chatTitle">Выберите чат</span>
      <button class="admin-btn" id="writeAdminBtn">Написать админу</button>
      <button class="admin-btn" id="viewChatsBtn" style="display:none;">Посмотреть чаты</button>
    </div>
    <div class="messages" id="messages"></div>
    <div class="composer">
      <input type="text" id="messageInput" placeholder="Введите сообщение">
      <button id="sendBtn">Отправить</button>
    </div>
  </div>
</div>

<script>
const socket = io();

let currentUser = localStorage.getItem('currentUser');
let selectedChat = 'Общий чат';

const authScreen = document.getElementById('authScreen');
const appScreen = document.getElementById('app');
const loginBtn = document.getElementById('loginBtn');
const nameInput = document.getElementById('nameInput');
const usersList = document.getElementById('usersList');
const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const chatTitle = document.getElementById('chatTitle');
const writeAdminBtn = document.getElementById('writeAdminBtn');
const viewChatsBtn = document.getElementById('viewChatsBtn');
const generalGroup = document.getElementById('generalGroup');

function renderUsers(users){
  usersList.innerHTML = '';
  users.forEach(u=>{
    if(u===currentUser) return;
    const div = document.createElement('div');
    div.className = 'category-item';
    div.textContent = u;
    div.onclick = ()=>selectChat(u);
    usersList.appendChild(div);
  });
}

function selectChat(chat){
  selectedChat = chat;
  chatTitle.textContent = chat;
  socket.emit('getMessages'); // просто триггер для обновления
}

function renderMessages(msgs){
  messagesDiv.innerHTML='';
  msgs.forEach(m=>{
    if(selectedChat==='Общий чат' && m.to==='ALL' || m.from===selectedChat || m.to===selectedChat || (currentUser==='KA7')){
      const div = document.createElement('div');
      div.className = 'msg '+(m.from===currentUser?'me':'');
      div.textContent = m.from+': '+m.text;
      messagesDiv.appendChild(div);
    }
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// --- События ---
loginBtn.onclick = ()=>{
  const name = nameInput.value.trim();
  if(!name) return alert('Введите имя!');
  socket.emit('login', name, (res)=>{
    if(!res.success) return alert(res.msg);
    currentUser = name;
    localStorage.setItem('currentUser', currentUser);
    authScreen.style.display='none';
    appScreen.style.display='flex';
    renderUsers(res.users);
    renderMessages(res.messages);
    if(currentUser==='KA7') viewChatsBtn.style.display='inline-block';
    else writeAdminBtn.style.display='inline-block';
  });
};

generalGroup.onclick = ()=>selectChat('Общий чат');
sendBtn.onclick = ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  socket.emit('sendMessage', {from: currentUser, to: selectedChat==='Общий чат'?'ALL':selectedChat, text});
  messageInput.value='';
};

writeAdminBtn.onclick = ()=>{
  selectedChat='KA7';
  chatTitle.textContent='Админ KA7';
};

socket.on('updateUsers', (users)=> renderUsers(users));
socket.on('newMessage', (msg)=> renderMessages([msg]));

document.addEventListener('keydown', e=>{
  if(e.key==='Enter') sendBtn.onclick();
});

// Если авторизован
if(currentUser){
  socket.emit('login', currentUser, (res)=>{
    authScreen.style.display='none';
    appScreen.style.display='flex';
    renderUsers(res.users);
    renderMessages(res.messages);
 
