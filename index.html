<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io('http://localhost:3000'); // адрес сервера

let currentUser = null;
let selectedChat = 'Общий чат';

const authScreen = document.getElementById('authScreen');
const appScreen = document.getElementById('app');
const loginBtn = document.getElementById('loginBtn');
const nameInput = document.getElementById('nameInput');
const usersList = document.getElementById('usersList');
const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const chatTitle = document.getElementById('chatTitle');
const createGroupBtn = document.getElementById('createGroupBtn');
const adminPanel = document.getElementById('adminPanel');
const writeAdminBtn = document.getElementById('writeAdminBtn');
const viewChatsBtn = document.getElementById('viewChatsBtn');

// Логин
loginBtn.addEventListener('click', () => {
  const name = nameInput.value.trim();
  if(!name){ alert('Введите имя!'); return; }
  currentUser = name;

  socket.emit('login', name, response => {
    if(!response.success){ alert('Имя занято!'); return; }

    authScreen.style.display='none';
    appScreen.style.display='flex';
    renderUsersList();

    selectChat('Общий чат');

    if(currentUser==='KA7'){
      renderAdminPanel();
      viewChatsBtn.style.display='inline-block';
    } else {
      writeAdminBtn.style.display='inline-block';
    }
  });
});

// Получаем список пользователей
socket.on('users', list => renderUsersList(list));

// Получаем новые сообщения
socket.on('newMessage', msg => renderMessages([msg]));

// Отправка сообщения
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });

function sendMessage(){
  const text = messageInput.value.trim();
  if(!text) return;

  const to = (selectedChat==='Общий чат')?'ALL':selectedChat;
  const msg = { from:currentUser, to, text, time:Date.now() };
  socket.emit('sendMessage', msg);
  renderMessages([msg]);
  messageInput.value='';
}

function renderMessages(msgs){
  msgs.forEach(m=>{
    if(currentUser!=='KA7' && m.to!==currentUser && m.from!==currentUser && m.to!=='ALL') return;

    const div = document.createElement('div');
    div.className='msg '+(m.from===currentUser?'me':'');
    div.style.opacity = 0;
    div.textContent = m.from+': '+m.text;
    messagesDiv.appendChild(div);

    // Анимация появления
    setTimeout(()=>{ div.style.transition='opacity 0.3s'; div.style.opacity=1; },10);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function renderUsersList(list=[]){
  usersList.innerHTML='';
  list.filter(u=>u!==currentUser).forEach(u=>{
    const div = document.createElement('div');
    div.textContent = u;
    div.className='category-item';
    div.onclick = ()=>selectChat(u);
    usersList.appendChild(div);
  });
}

function selectChat(name){
  selectedChat = name;
  chatTitle.textContent = name;
  messagesDiv.innerHTML='';
}

// Написать админу
writeAdminBtn.addEventListener('click', ()=>selectChat('KA7'));

// Создать группу
createGroupBtn.addEventListener('click', ()=>alert('Еще в разработке'));

// Админская панель
function renderAdminPanel(){
  adminPanel.innerHTML='<div style="font-weight:700;margin-bottom:6px;">Выберите чат пользователя:</div>';
  socket.emit('requestUsers'); // сервер вернет список
  socket.on('users', list=>{
    list.filter(u=>u!=='KA7').forEach(u=>{
      const btn = document.createElement('button');
      btn.textContent = u;
      btn.style.marginBottom='4px';
      btn.onclick = ()=>selectChat(u);
      adminPanel.appendChild(btn);
    });
  });
}
</script>
