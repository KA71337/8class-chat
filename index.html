<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>8Ч Класс — Мини чат</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --g1: linear-gradient(135deg,#667eea,#764ba2);
      --btn-shadow: 0 6px 18px rgba(102,126,234,0.18);
    }
    body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);height:100vh;display:flex;justify-content:center;align-items:center;}
    .auth{background:white;padding:34px;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,0.25);text-align:center;width:430px;}
    .auth h1{margin:0 0 8px;font-size:22px;color:#222;}
    .notice{color:#7a1f1f;font-size:13px;background:#fff3f2;padding:8px;border-radius:8px;border:1px solid rgba(250,215,215,0.6);margin-bottom:12px;}
    input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:14px;outline:none;box-sizing:border-box;}
    input[type="text"]:focus{box-shadow:var(--btn-shadow);border-color:#667eea;}
    .btn{display:inline-block;padding:10px 16px;border-radius:10px;border:none;background:var(--g1);color:white;font-weight:600;cursor:pointer;transition:transform .18s,box-shadow .18s;}
    .btn:active{transform:translateY(1px);}
    .btn:hover{transform:translateY(-4px);box-shadow:var(--btn-shadow);}
    /* app */
    .app{display:none;width:94%;max-width:1100px;height:88vh;background:white;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,0.28);overflow:hidden;display:flex;flex-direction:row;}
    .sidebar{width:260px;background:#f7f8ff;border-right:1px solid #e6e6ef;padding:16px;box-sizing:border-box;overflow:auto;}
    .category{font-weight:700;margin-top:10px;margin-bottom:6px;color:#333;}
    .item{padding:8px 10px;border-radius:8px;margin-bottom:6px;background:transparent;color:#333;cursor:pointer;transition:all .12s;}
    .item:hover{background:rgba(102,126,234,0.06);transform:translateX(4px);}
    .chat-area{flex:1;display:flex;flex-direction:column;}
    .chat-header{height:60px;display:flex;align-items:center;padding:0 18px;border-bottom:1px solid #eee;justify-content:space-between;}
    .title{font-weight:700;}
    .messages{flex:1;padding:18px;overflow:auto;background:#fbfbff;display:flex;flex-direction:column;gap:10px;}
    .bubble{max-width:70%;padding:10px 14px;border-radius:12px;background:#eef2ff;align-self:flex-start;}
    .bubble.me{align-self:flex-end;background:linear-gradient(90deg,#667eea,#764ba2);color:white;}
    .composer{display:flex;gap:10px;padding:14px;border-top:1px solid #eee;}
    .composer input{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:14px;outline:none;}
    .small-btn{padding:8px 10px;border-radius:8px;border:none;background:var(--g1);color:#fff;cursor:pointer;transition:transform .14s;}
    .small-btn:hover{transform:translateY(-3px);box-shadow:var(--btn-shadow);}
    /* top buttons */
    .top-left, .top-right{position:absolute;z-index:30}
    .top-left{left:18px;top:14px}
    .top-right{right:18px;top:14px}
    /* admin panel overlay */
    .admin-panel{position:absolute;left:18px;top:60px;background:#fff;border-radius:10px;padding:10px;box-shadow:0 12px 30px rgba(0,0,0,0.2);display:none;max-height:70vh;overflow:auto;min-width:220px;}
    .admin-panel h4{margin:0 0 8px 0;font-size:14px;}
    .exit-view{margin-top:8px;padding:6px 10px;border-radius:8px;border:none;background:#e74c3c;color:#fff;cursor:pointer;}
    /* minor */
    .muted{font-size:13px;color:#666}
  </style>
</head>
<body>

  <!-- авторизация -->
  <div class="auth" id="auth">
    <h1>Добро пожаловать на сайт 8ч класса</h1>
    <div class="notice">Ваши чаты нифига не конфиденциальны и не безопасны</div>
    <input id="nameInput" type="text" placeholder="Введите своё имя (не Gmail)" />
    <div style="height:12px"></div>
    <button class="btn" id="loginBtn">Войти</button>
  </div>

  <!-- приложение -->
  <div class="app" id="app" style="position:relative;">
    <!-- кнопки сверху -->
    <div class="top-left">
      <button class="small-btn" id="viewChatsBtn" title="Посмотреть чаты (только KA7)" style="display:none">Посмотреть чаты</button>
    </div>
    <div class="top-right">
      <button class="small-btn" id="writeAdminBtn" title="Написать админу">Написать админу</button>
    </div>

    <div class="sidebar" id="sidebar">
      <div class="category">Группы</div>
      <div class="item" data-chat="Общий" id="group_general">Общий чат</div>

      <div class="category">Чаты</div>
      <div id="usersList"></div>
    </div>

    <div class="chat-area">
      <div class="chat-header">
        <div class="title" id="chatTitle">Выберите чат</div>
        <div class="muted" id="status"> </div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <input id="messageInput" placeholder="Введите сообщение и нажмите Enter" />
        <button class="small-btn" id="sendBtn">Отправить</button>
      </div>
    </div>

    <!-- админская панель (список пользователей для просмотра) -->
    <div class="admin-panel" id="adminPanel">
      <h4>Выберите чат пользователя</h4>
      <div id="adminUsersList"></div>
      <button class="exit-view" id="exitViewBtn" style="display:none">Выйти из просмотра</button>
    </div>
  </div>

<script>
(() => {
  // Адрес локального сервера
  const socket = io("http://localhost:3000");

  // состояние
  let currentUser = localStorage.getItem("currentUser") || null;
  let users = [];           // список онлайн-пользователей (строки)
  let messages = [];        // {from,to,text,time}
  let selectedChat = "Общий";   // 'Общий' или имя пользователя
  let adminViewing = false; // режим просмотра админа
  let adminViewedUser = null;

  // элементы
  const authBox = document.getElementById("auth");
  const appBox = document.getElementById("app");
  const loginBtn = document.getElementById("loginBtn");
  const nameInput = document.getElementById("nameInput");
  const viewChatsBtn = document.getElementById("viewChatsBtn");
  const writeAdminBtn = document.getElementById("writeAdminBtn");
  const usersListDiv = document.getElementById("usersList");
  const messagesDiv = document.getElementById("messages");
  const chatTitle = document.getElementById("chatTitle");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const adminPanel = document.getElementById("adminPanel");
  const adminUsersList = document.getElementById("adminUsersList");
  const exitViewBtn = document.getElementById("exitViewBtn");
  const statusDiv = document.getElementById("status");

  // Инициализация UI в зависимости от сохраненного имени
  if (currentUser) {
    showApp();
    socket.emit("login", currentUser, (res) => {
      if (!res || !res.success) {
        // Имя занято или ошибка — убираем кеш и показываем auth
        localStorage.removeItem("currentUser");
        alert((res && res.message) || "Ошибка авторизации — попробуйте заново");
        location.reload();
        return;
      }
      users = res.users || [];
      messages = res.messages || [];
      onLoginSetup();
    });
  }

  // ================== UI handlers ==================
  loginBtn.addEventListener("click", () => {
    const name = nameInput.value.trim();
    if (!name) return alert("Введите имя!");
    socket.emit("login", name, (res) => {
      if (!res) return alert("Ошибка соединения с сервером");
      if (!res.success) return alert(res.message || "Имя занято");
      currentUser = name;
      localStorage.setItem("currentUser", name);
      users = res.users || [];
      messages = res.messages || [];
      showApp();
      onLoginSetup();
    });
  });

  function onLoginSetup(){
    renderUsers();
    renderMessages();
    // показать/скрыть кнопки
    if (currentUser === "KA7") {
      viewChatsBtn.style.display = "inline-block"; // админ только
      // admin panel hidden by default
    } else {
      viewChatsBtn.style.display = "none";
    }
    writeAdminBtn.style.display = "inline-block";
    // status
    statusDiv.textContent = `Вы: ${currentUser}`;
  }

  function showApp(){
    authBox.style.display = "none";
    appBox.style.display = "flex";
  }

  // Показываем список пользователей (в сайдбаре)
  function renderUsers(){
    usersListDiv.innerHTML = ""; // пустой
    // 'Общий' уже в DOM как group, но добавим участников ниже
    const others = users.filter(u => u !== currentUser);
    others.forEach(u=>{
      const el = document.createElement("div");
      el.className = "item";
      el.textContent = u;
      el.onclick = () => {
        // выключаем админский режим просмотра (если был)
        adminViewing = false;
        adminViewedUser = null;
        adminPanel.style.display = "none";
        exitViewBtn.style.display = "none";

        selectedChat = u;
        chatTitle.textContent = u;
        renderMessages();
      };
      usersListDiv.appendChild(el);
    });
  }

  // Рендер сообщений в зависимости от выбранного чата / режима
  function renderMessages(){
    messagesDiv.innerHTML = "";
    // filter messages according to mode:
    let filtered = [];
    if (adminViewing && currentUser === "KA7" && adminViewedUser) {
      // щелчок админа — показываем все сообщения где участвует adminViewedUser
      filtered = messages.filter(m => m.from === adminViewedUser || m.to === adminViewedUser);
      chatTitle.textContent = `Просмотр чатов: ${adminViewedUser}`;
      exitViewBtn.style.display = "inline-block";
    } else {
      exitViewBtn.style.display = "none";
      if (selectedChat === "Общий") {
        filtered = messages.filter(m => m.to === "Общий");
        chatTitle.textContent = "Общий чат";
      } else {
        // приватный диалог между currentUser и selectedChat
        filtered = messages.filter(m =>
          (m.from === currentUser && m.to === selectedChat) ||
          (m.from === selectedChat && m.to === currentUser)
        );
        chatTitle.textContent = selectedChat;
      }
    }

    // упорядочить по времени
    filtered.sort((a,b)=> (a.time||0) - (b.time||0));

    filtered.forEach(m => {
      const div = document.createElement("div");
      div.className = "bubble" + (m.from === currentUser ? " me" : "");
      div.textContent = `${m.from}: ${m.text}`;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    // Save local backup (не источник истины)
    localStorage.setItem("chat_backup_messages", JSON.stringify(messages));
  }

  // Отправка сообщения
  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;
    // определить цель
    let to;
    if (adminViewing && currentUser === "KA7" && adminViewedUser) {
      to = adminViewedUser; // админ отвечает выбранному пользователю
    } else {
      to = selectedChat || "Общий";
    }
    const payload = { from: currentUser, to, text };
    socket.emit("sendMessage", payload);
    messageInput.value = "";
  }

  sendBtn.addEventListener("click", sendMessage);
  messageInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

  // Написать админу (любому пользователю видно)
  writeAdminBtn.addEventListener("click", () => {
    if (!currentUser) return alert("Сначала авторизуйтесь");
    const text = prompt("Введите сообщение админу:");
    if (!text) return;
    socket.emit("sendMessage", { from: currentUser, to: "KA7", text });
  });

  // ============== админская логика: показать панель со списком юзеров ==============
  viewChatsBtn.addEventListener("click", () => {
    if (currentUser !== "KA7") return; // защита
    // запросим актуальный список пользователей у сервера
    socket.emit("getUsers", (list) => {
      // server may send back via callback or via 'users' event; fallback to last known
      if (Array.isArray(list)) {
        users = list;
      }
      // show admin panel
      adminUsersList.innerHTML = "";
      const arr = users.filter(u => u !== "KA7");
      if (arr.length === 0) {
        adminUsersList.innerHTML = "<div class='muted'>Нет пользователей</div>";
      } else {
        arr.forEach(u => {
          const b = document.createElement("div");
          b.className = "item";
          b.style.padding = "8px";
          b.textContent = u;
          b.onclick = () => {
            adminViewing = true;
            adminViewedUser = u;
            // adminRequested messages for that user from server (to ensure full history)
            socket.emit("getMessagesForUser", u, (msgs) => {
              if (Array.isArray(msgs)) {
                // merge server messages into local messages store (avoid duplicates)
                // simple merge: concat and dedupe by time+from+to+text
                const merged = (messages || []).concat(msgs || []);
                const seen = new Set();
                messages = merged.filter(m => {
                  const key = `${m.time}|${m.from}|${m.to}|${m.text}`;
                  if (seen.has(key)) return false;
                  seen.add(key);
                  return true;
                });
                renderMessages();
              } else {
                // если сервер не вернул, всё равно рендерим по локальному
                renderMessages();
              }
            });
            // отобразим панель закрытой
            adminPanel.style.display = "block";
          };
          adminUsersList.appendChild(b);
        });
      }
      // показываем панель (если была скрыта)
      adminPanel.style.display = "block";
    });
  });

  // Выход из режима просмотра
  exitViewBtn.addEventListener("click", () => {
    adminViewing = false;
    adminViewedUser = null;
    adminPanel.style.display = "none";
    selectedChat = "Общий";
    renderMessages();
  });

  // Кнопка "Посмотреть чаты" в левом верхнем углу также может просто переключить на общий
  document.getElementById("group_general").addEventListener("click", () => {
    adminViewing = false; adminViewedUser = null;
    selectedChat = "Общий";
    renderMessages();
  });

  // ============== socket events ==============
  socket.on("connect", () => {
    console.log("socket connected");
  });

  socket.on("users", (list) => {
    if (!Array.isArray(list)) return;
    users = list;
    renderUsers();
    // если админ, обновим админскую панель лист
    if (currentUser === "KA7") {
      // do nothing now; adminPanel populates when clicked (or optionally refresh)
    }
  });

  socket.on("newMessage", (msg) => {
    // msg: {from,to,text,time}
    // Добавляем в messages (дедупlication)
    if (!msg || !msg.from) return;
    const key = `${msg.time}|${msg.from}|${msg.to}|${msg.text}`;
    const exists = messages.some(m => `${m.time}|${m.from}|${m.to}|${m.text}` === key);
    if (!exists) messages.push(msg);
    // если текущее окно должно показать это сообщение — отрисуем
    if (adminViewing && currentUser === "KA7" && adminViewedUser) {
      if (msg.from === adminViewedUser || msg.to === adminViewedUser) renderMessages();
    } else {
      // обычный режим: показываем если сообщение относилось к текущему чату
      if ( (selectedChat === "Общий" && msg.to === "Общий")
        || (selectedChat !== "Общий" && ((msg.from === selectedChat && msg.to === currentUser) || (msg.from === currentUser && msg.to === selectedChat))) ) {
        renderMessages();
      }
    }
    // save backup
    localStorage.setItem("chat_backup_messages", JSON.stringify(messages));
  });

  socket.on("disconnect", () => {
    console.log("socket disconnected");
  });

  // helper: renderUsers uses users[] and writes to sidebar; also will include 'Общий' group at top already
  function renderUsers(){
    // rebuild the list (we have category titles already)
    const container = usersListDiv;
    container.innerHTML = "";
    const others = users.filter(u => u !== currentUser);
    if (others.length === 0) {
      const el = document.createElement("div"); el.className = "item muted"; el.textContent = "Нет пользователей"; container.appendChild(el); return;
    }
    others.forEach(u => {
      const el = document.createElement("div");
      el.className = "item";
      el.textContent = u;
      el.onclick = () => {
        adminViewing = false; adminViewedUser = null; adminPanel.style.display = "none";
        selectedChat = u;
        renderMessages();
      };
      container.appendChild(el);
    });
  }

  // ensure UI correctness: only admin sees viewChatsBtn
  function refreshButtonsVisibility(){
    if (currentUser === "KA7") {
      viewChatsBtn.style.display = "inline-block";
    } else {
      viewChatsBtn.style.display = "none";
    }
  }

  // initial visibility
  refreshButtonsVisibility();

})();
</script>
</body>
</html>
